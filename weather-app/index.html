<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>WeatherSphere Pro | Real-time Weather Dashboard</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <style>
        :root {
            --primary: #4361ee;
            --secondary: #3f37c9;
            --accent: #4895ef;
            --light: #f8f9fa;
            --dark: #212529;
            --success: #4cc9f0;
            --warning: #f72585;
            --info: #560bad;
            --card-bg: rgba(255, 255, 255, 0.85);
            --text-primary: #2b2d42;
            --text-secondary: #8d99ae;
            --transition: all 0.3s cubic-bezier(0.25, 0.8, 0.25, 1);
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Poppins', sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            color: var(--text-primary);
            line-height: 1.6;
            padding: 20px;
            background-attachment: fixed;
            background-size: cover;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
        }

        .weather-app {
            background: var(--card-bg);
            border-radius: 20px;
            box-shadow: 0 15px 30px rgba(0, 0, 0, 0.2);
            overflow: hidden;
            backdrop-filter: blur(10px);
            animation: fadeIn 0.8s ease-out;
            transition: var(--transition);
        }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(20px); }
            to { opacity: 1; transform: translateY(0); }
        }

        .app-header {
            background: linear-gradient(to right, var(--primary), var(--secondary));
            color: white;
            padding: 20px 30px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .app-title {
            font-size: 1.8rem;
            font-weight: 600;
        }

        .app-version {
            font-size: 0.9rem;
            opacity: 0.8;
        }

        .search-section {
            padding: 25px 30px;
            border-bottom: 1px solid rgba(0, 0, 0, 0.1);
        }

        .search-container {
            display: flex;
            gap: 12px;
        }

        .search-input {
            flex: 1;
            padding: 15px 20px;
            border: none;
            border-radius: 12px;
            font-size: 1rem;
            background: rgba(255, 255, 255, 0.9);
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.05);
            transition: var(--transition);
        }

        .search-input:focus {
            outline: none;
            box-shadow: 0 2px 15px rgba(67, 97, 238, 0.3);
        }

        .search-btn, .location-btn {
            width: 50px;
            height: 50px;
            border: none;
            border-radius: 12px;
            background: var(--primary);
            color: white;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: var(--transition);
            box-shadow: 0 2px 10px rgba(67, 97, 238, 0.3);
        }

        .location-btn {
            background: var(--accent);
        }

        .search-btn:hover, .location-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(67, 97, 238, 0.4);
        }

        .search-btn:active, .location-btn:active {
            transform: translateY(0);
        }

        .unit-toggle {
            display: flex;
            margin-top: 15px;
            background: rgba(255, 255, 255, 0.7);
            border-radius: 12px;
            padding: 5px;
            width: fit-content;
        }

        .unit-btn {
            padding: 8px 20px;
            border: none;
            background: none;
            cursor: pointer;
            font-weight: 500;
            border-radius: 8px;
            transition: var(--transition);
        }

        .unit-btn.active {
            background: white;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
            color: var(--primary);
        }

        .main-content {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
            padding: 30px;
        }

        @media (max-width: 768px) {
            .main-content {
                grid-template-columns: 1fr;
            }
        }

        .current-weather {
            background: linear-gradient(135deg, rgba(67, 97, 238, 0.1) 0%, rgba(63, 55, 201, 0.1) 100%);
            border-radius: 16px;
            padding: 25px;
            position: relative;
            overflow: hidden;
        }

        .current-weather::before {
            content: '';
            position: absolute;
            top: -50px;
            right: -50px;
            width: 150px;
            height: 150px;
            background: rgba(255, 255, 255, 0.1);
            border-radius: 50%;
        }

        .location-info {
            margin-bottom: 20px;
        }

        .city-name {
            font-size: 1.8rem;
            font-weight: 600;
            margin-bottom: 5px;
        }

        .date-time {
            color: var(--text-secondary);
            font-size: 0.9rem;
        }

        .weather-main {
            display: flex;
            align-items: center;
            margin-bottom: 20px;
        }

        .temperature {
            font-size: 4rem;
            font-weight: 300;
            margin-right: 20px;
            line-height: 1;
            background: linear-gradient(to right, var(--primary), var(--secondary));
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
        }

        .weather-icon {
            width: 100px;
            height: 100px;
            margin-right: 20px;
        }

        .weather-description {
            text-transform: capitalize;
            font-size: 1.2rem;
            color: var(--text-secondary);
        }

        .weather-details {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 15px;
            margin-top: 25px;
        }

        .detail-card {
            background: white;
            border-radius: 12px;
            padding: 15px;
            display: flex;
            align-items: center;
            box-shadow: 0 3px 10px rgba(0, 0, 0, 0.05);
            transition: var(--transition);
        }

        .detail-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.1);
        }

        .detail-icon {
            width: 40px;
            height: 40px;
            background: rgba(67, 97, 238, 0.1);
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            margin-right: 15px;
            color: var(--primary);
        }

        .detail-info h4 {
            font-size: 0.8rem;
            color: var(--text-secondary);
            margin-bottom: 3px;
        }

        .detail-info p {
            font-weight: 500;
        }

        .forecast-section {
            background: white;
            border-radius: 16px;
            padding: 25px;
            box-shadow: 0 3px 15px rgba(0, 0, 0, 0.05);
        }

        .section-title {
            font-size: 1.3rem;
            margin-bottom: 20px;
            display: flex;
            align-items: center;
        }

        .section-title i {
            margin-right: 10px;
            color: var(--primary);
        }

        .hourly-forecast {
            display: flex;
            gap: 15px;
            overflow-x: auto;
            padding-bottom: 15px;
            margin-bottom: 25px;
            scrollbar-width: thin;
            scrollbar-color: var(--primary) rgba(0, 0, 0, 0.1);
        }

        .hourly-forecast::-webkit-scrollbar {
            height: 6px;
        }

        .hourly-forecast::-webkit-scrollbar-track {
            background: rgba(0, 0, 0, 0.1);
            border-radius: 10px;
        }

        .hourly-forecast::-webkit-scrollbar-thumb {
            background-color: var(--primary);
            border-radius: 10px;
        }

        .hourly-item {
            min-width: 80px;
            text-align: center;
            background: rgba(67, 97, 238, 0.05);
            border-radius: 10px;
            padding: 12px;
            transition: var(--transition);
        }

        .hourly-item:hover {
            background: rgba(67, 97, 238, 0.1);
        }

        .hourly-time {
            font-size: 0.8rem;
            font-weight: 500;
            margin-bottom: 8px;
        }

        .hourly-icon {
            width: 40px;
            height: 40px;
            margin: 0 auto 8px;
        }

        .hourly-temp {
            font-weight: 600;
        }

        .daily-forecast {
            display: grid;
            gap: 12px;
        }

        .daily-item {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 12px 15px;
            background: rgba(67, 97, 238, 0.05);
            border-radius: 10px;
            transition: var(--transition);
        }

        .daily-item:hover {
            background: rgba(67, 97, 238, 0.1);
        }

        .daily-day {
            font-weight: 500;
            min-width: 100px;
        }

        .daily-icon {
            width: 30px;
            height: 30px;
        }

        .daily-temps {
            display: flex;
            gap: 15px;
        }

        .daily-max {
            font-weight: 600;
            min-width: 40px;
            text-align: right;
        }

        .daily-min {
            color: var(--text-secondary);
            min-width: 40px;
            text-align: right;
        }

        .additional-features {
            grid-column: span 2;
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 20px;
            margin-top: 20px;
        }

        @media (max-width: 992px) {
            .additional-features {
                grid-template-columns: repeat(2, 1fr);
            }
        }

        @media (max-width: 576px) {
            .additional-features {
                grid-template-columns: 1fr;
            }
        }

        .feature-card {
            background: white;
            border-radius: 16px;
            padding: 20px;
            box-shadow: 0 3px 15px rgba(0, 0, 0, 0.05);
            transition: var(--transition);
        }

        .feature-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 10px 25px rgba(0, 0, 0, 0.1);
        }

        .feature-title {
            font-size: 1rem;
            margin-bottom: 15px;
            display: flex;
            align-items: center;
            color: var(--primary);
        }

        .feature-title i {
            margin-right: 10px;
            font-size: 1.2rem;
        }

        .feature-content {
            font-size: 0.9rem;
            color: var(--text-secondary);
        }

        .air-quality-index {
            display: flex;
            align-items: center;
            margin-top: 10px;
        }

        .aqi-value {
            font-size: 1.8rem;
            font-weight: 600;
            margin-right: 15px;
            color: var(--primary);
        }

        .aqi-category {
            padding: 5px 10px;
            border-radius: 20px;
            font-size: 0.8rem;
            font-weight: 500;
            background: var(--success);
            color: white;
        }

        .aqi-good { background: #4cc9f0; }
        .aqi-moderate { background: #4895ef; }
        .aqi-unhealthy-sensitive { background: #4361ee; }
        .aqi-unhealthy { background: #3f37c9; }
        .aqi-very-unhealthy { background: #560bad; }
        .aqi-hazardous { background: #f72585; }

        .sun-times {
            display: flex;
            justify-content: space-between;
            margin-top: 15px;
        }

        .sun-time {
            text-align: center;
        }

        .sun-time i {
            font-size: 1.5rem;
            color: var(--warning);
            margin-bottom: 5px;
        }

        .sunrise i {
            color: #ff9e00;
        }

        .sunset i {
            color: #ff6b6b;
        }

        .sun-time-label {
            font-size: 0.8rem;
            color: var(--text-secondary);
        }

        .sun-time-value {
            font-weight: 500;
        }

        .map-container {
            height: 200px;
            border-radius: 12px;
            overflow: hidden;
            margin-top: 15px;
            background: #eee;
            position: relative;
        }

        .map-placeholder {
            width: 100%;
            height: 100%;
            display: flex;
            align-items: center;
            justify-content: center;
            color: var(--text-secondary);
            font-size: 0.9rem;
        }

        .loading-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.7);
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            z-index: 1000;
            color: white;
            opacity: 0;
            pointer-events: none;
            transition: opacity 0.3s ease;
        }

        .loading-overlay.active {
            opacity: 1;
            pointer-events: all;
        }

        .spinner {
            width: 50px;
            height: 50px;
            border: 5px solid rgba(255, 255, 255, 0.3);
            border-radius: 50%;
            border-top-color: white;
            animation: spin 1s ease-in-out infinite;
            margin-bottom: 20px;
        }

        @keyframes spin {
            to { transform: rotate(360deg); }
        }

        .error-message {
            background: var(--warning);
            color: white;
            padding: 15px 20px;
            border-radius: 10px;
            margin: 20px 30px;
            display: flex;
            align-items: center;
            display: none;
        }

        .error-message i {
            margin-right: 10px;
            font-size: 1.2rem;
        }

        .error-message.active {
            display: flex;
        }

        .app-footer {
            text-align: center;
            margin-top: 30px;
            color: white;
            font-size: 0.9rem;
            opacity: 0.8;
        }

        .app-footer a {
            color: white;
            text-decoration: none;
            font-weight: 500;
        }

        /* Animation classes */
        .pulse {
            animation: pulse 2s infinite;
        }

        @keyframes pulse {
            0% { transform: scale(1); }
            50% { transform: scale(1.05); }
            100% { transform: scale(1); }
        }

        /* Responsive adjustments */
        @media (max-width: 768px) {
            .app-header {
                flex-direction: column;
                text-align: center;
                gap: 10px;
            }
            
            .search-section {
                padding: 20px;
            }
            
            .main-content {
                padding: 20px;
            }
            
            .temperature {
                font-size: 3rem;
            }
            
            .weather-icon {
                width: 80px;
                height: 80px;
            }
        }

        @media (max-width: 576px) {
            .weather-details {
                grid-template-columns: 1fr;
            }
            
            .search-container {
                flex-direction: column;
            }
            
            .search-input {
                width: 100%;
            }
            
            .search-btn, .location-btn {
                width: 100%;
                height: 45px;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="weather-app pulse">
            <div class="app-header">
                <div class="app-title">WeatherSphere Pro</div>
                <div class="app-version">v2.1.0</div>
            </div>
            
            <div class="error-message" id="error-message">
                <i class="fas fa-exclamation-circle"></i>
                <span id="error-text">Error message will appear here</span>
            </div>
            
            <div class="search-section">
                <div class="search-container">
                    <input type="text" id="city-input" class="search-input" placeholder="Search for a city..." aria-label="City name">
                    <button id="search-btn" class="search-btn" aria-label="Search">
                        <i class="fas fa-search"></i>
                    </button>
                    <button id="location-btn" class="location-btn" aria-label="Use current location">
                        <i class="fas fa-location-arrow"></i>
                    </button>
                </div>
                
                <div class="unit-toggle">
                    <button id="celsius-btn" class="unit-btn active">°C</button>
                    <button id="fahrenheit-btn" class="unit-btn">°F</button>
                </div>
            </div>
            
            <div class="main-content">
                <div class="current-weather">
                    <div class="location-info">
                        <h1 class="city-name" id="city-name">--</h1>
                        <div class="date-time" id="date-time">--</div>
                    </div>
                    
                    <div class="weather-main">
                        <div class="temperature" id="temperature">--°</div>
                        <img class="weather-icon" id="weather-icon" src="" alt="Weather icon">
                        <div class="weather-description" id="weather-description">--</div>
                    </div>
                    
                    <div class="weather-details">
                        <div class="detail-card">
                            <div class="detail-icon">
                                <i class="fas fa-tint"></i>
                            </div>
                            <div class="detail-info">
                                <h4>Humidity</h4>
                                <p id="humidity">--%</p>
                            </div>
                        </div>
                        
                        <div class="detail-card">
                            <div class="detail-icon">
                                <i class="fas fa-wind"></i>
                            </div>
                            <div class="detail-info">
                                <h4>Wind Speed</h4>
                                <p id="wind-speed">-- km/h</p>
                            </div>
                        </div>
                        
                        <div class="detail-card">
                            <div class="detail-icon">
                                <i class="fas fa-temperature-low"></i>
                            </div>
                            <div class="detail-info">
                                <h4>Feels Like</h4>
                                <p id="feels-like">--°</p>
                            </div>
                        </div>
                        
                        <div class="detail-card">
                            <div class="detail-icon">
                                <i class="fas fa-compress-arrows-alt"></i>
                            </div>
                            <div class="detail-info">
                                <h4>Pressure</h4>
                                <p id="pressure">-- hPa</p>
                            </div>
                        </div>
                    </div>
                </div>
                
                <div class="forecast-section">
                    <h2 class="section-title">
                        <i class="fas fa-clock"></i> Hourly Forecast
                    </h2>
                    <div class="hourly-forecast" id="hourly-forecast">
                        <!-- Hourly forecast items will be inserted here -->
                    </div>
                    
                    <h2 class="section-title">
                        <i class="fas fa-calendar-alt"></i> 5-Day Forecast
                    </h2>
                    <div class="daily-forecast" id="daily-forecast">
                        <!-- Daily forecast items will be inserted here -->
                    </div>
                </div>
                
                <div class="additional-features">
                    <div class="feature-card">
                        <h3 class="feature-title">
                            <i class="fas fa-wind"></i> Air Quality
                        </h3>
                        <div class="feature-content">
                            <div class="air-quality-index">
                                <div class="aqi-value" id="aqi-value">--</div>
                                <div class="aqi-category" id="aqi-category">--</div>
                            </div>
                            <p id="air-quality-desc">Air quality data not available</p>
                        </div>
                    </div>
                    
                    <div class="feature-card">
                        <h3 class="feature-title">
                            <i class="fas fa-sun"></i> Sun Times
                        </h3>
                        <div class="feature-content">
                            <div class="sun-times">
                                <div class="sun-time sunrise">
                                    <i class="fas fa-sunrise"></i>
                                    <div class="sun-time-label">Sunrise</div>
                                    <div class="sun-time-value" id="sunrise">--:--</div>
                                </div>
                                <div class="sun-time sunset">
                                    <i class="fas fa-sunset"></i>
                                    <div class="sun-time-label">Sunset</div>
                                    <div class="sun-time-value" id="sunset">--:--</div>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <div class="feature-card">
                        <h3 class="feature-title">
                            <i class="fas fa-map-marked-alt"></i> Location Map
                        </h3>
                        <div class="feature-content">
                            <div class="map-container">
                                <div class="map-placeholder">
                                    Map will load when location is selected
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <div class="feature-card">
                        <h3 class="feature-title">
                            <i class="fas fa-umbrella"></i> Precipitation
                        </h3>
                        <div class="feature-content">
                            <p>Rain: <span id="rain-volume">0</span> mm</p>
                            <p>Snow: <span id="snow-volume">0</span> mm</p>
                            <p>Chance of rain: <span id="rain-chance">0</span>%</p>
                        </div>
                    </div>
                    
                    <div class="feature-card">
                        <h3 class="feature-title">
                            <i class="fas fa-eye"></i> Visibility
                        </h3>
                        <div class="feature-content">
                            <p id="visibility">-- km</p>
                            <p id="uv-index">UV Index: --</p>
                        </div>
                    </div>
                    
                    <div class="feature-card">
                        <h3 class="feature-title">
                            <i class="fas fa-cloud"></i> Cloud Cover
                        </h3>
                        <div class="feature-content">
                            <p id="cloud-cover">--%</p>
                            <p id="dew-point">Dew point: --°</p>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        
        <div class="app-footer">
            <p>Powered by <a href="https://openweathermap.org" target="_blank">OpenWeatherMap</a> | &copy; 2023 WeatherSphere Pro</p>
        </div>
    </div>
    
    <div class="loading-overlay" id="loading-overlay">
        <div class="spinner"></div>
        <p>Loading weather data...</p>
    </div>

    <script>
        // Professional Weather App with Advanced Features
        document.addEventListener('DOMContentLoaded', function() {
            // Configuration
            const config = {
                apiKeys: {
                    weather: '2aa6a17f01dc8364a3f0df73b06d923e', // Replace with your OpenWeatherMap API key
                    airQuality: '109e10189518b3c0d01bccdb57ed97e5', // Replace with your AirVisual API key
                    map: 'pk.eyJ1IjoicmFqa3VtYXI4OSIsImEiOiJjbWN3YjZrcG8wMG42MmxxdDRkN3M1NWFnIn0.dHRPD6cZjLBmR8hOrOW5Iw' // Replace with your Mapbox API key
                },
                defaultCity: 'London',
                units: 'metric',
                cache: {
                    enabled: true,
                    duration: 15 * 60 * 1000 // 15 minutes
                },
                features: {
                    airQuality: true,
                    maps: true,
                    hourlyForecast: true
                },
                ui: {
                    animations: true,
                    theme: 'default'
                }
            };
            
            // DOM Elements
            const elements = {
                // Input elements
                cityInput: document.getElementById('city-input'),
                searchBtn: document.getElementById('search-btn'),
                locationBtn: document.getElementById('location-btn'),
                celsiusBtn: document.getElementById('celsius-btn'),
                fahrenheitBtn: document.getElementById('fahrenheit-btn'),
                
                // Display elements
                cityName: document.getElementById('city-name'),
                dateTime: document.getElementById('date-time'),
                temperature: document.getElementById('temperature'),
                weatherIcon: document.getElementById('weather-icon'),
                weatherDescription: document.getElementById('weather-description'),
                humidity: document.getElementById('humidity'),
                windSpeed: document.getElementById('wind-speed'),
                feelsLike: document.getElementById('feels-like'),
                pressure: document.getElementById('pressure'),
                visibility: document.getElementById('visibility'),
                uvIndex: document.getElementById('uv-index'),
                cloudCover: document.getElementById('cloud-cover'),
                dewPoint: document.getElementById('dew-point'),
                rainVolume: document.getElementById('rain-volume'),
                snowVolume: document.getElementById('snow-volume'),
                rainChance: document.getElementById('rain-chance'),
                sunrise: document.getElementById('sunrise'),
                sunset: document.getElementById('sunset'),
                aqiValue: document.getElementById('aqi-value'),
                aqiCategory: document.getElementById('aqi-category'),
                airQualityDesc: document.getElementById('air-quality-desc'),
                
                // Forecast containers
                hourlyForecast: document.getElementById('hourly-forecast'),
                dailyForecast: document.getElementById('daily-forecast'),
                
                // UI elements
                loadingOverlay: document.getElementById('loading-overlay'),
                errorMessage: document.getElementById('error-message'),
                errorText: document.getElementById('error-text'),
                weatherApp: document.querySelector('.weather-app')
            };
            
            // App State
            const state = {
                currentWeather: null,
                forecast: null,
                airQuality: null,
                location: null,
                unit: config.units,
                cache: new Map(),
                lastRequestTime: 0,
                map: null,
                mapInitialized: false
            };
            
            // Initialize the app
            init();
            
            function init() {
                setupEventListeners();
                loadDefaultCity();
                updateDateTime();
                setInterval(updateDateTime, 60000); // Update time every minute
            }
            
            function setupEventListeners() {
                // Search functionality
                elements.searchBtn.addEventListener('click', handleSearch);
                elements.locationBtn.addEventListener('click', handleLocation);
                elements.cityInput.addEventListener('keypress', (e) => {
                    if (e.key === 'Enter') handleSearch();
                });
                
                // Unit toggle
                elements.celsiusBtn.addEventListener('click', () => setUnits('metric'));
                elements.fahrenheitBtn.addEventListener('click', () => setUnits('imperial'));
                
                // Error message close
                elements.errorMessage.addEventListener('click', clearError);
            }
            
            function loadDefaultCity() {
                elements.cityInput.value = config.defaultCity;
                loadWeatherData(config.defaultCity);
            }
            
            function updateDateTime() {
                const now = new Date();
                const options = { 
                    weekday: 'long', 
                    year: 'numeric', 
                    month: 'long', 
                    day: 'numeric',
                    hour: '2-digit',
                    minute: '2-digit'
                };
                elements.dateTime.textContent = now.toLocaleDateString('en-US', options);
            }
            
            async function handleSearch() {
                const city = elements.cityInput.value.trim();
                if (!city) {
                    showError('Please enter a city name');
                    return;
                }
                await loadWeatherData(city);
            }
            
            async function handleLocation() {
                if (!navigator.geolocation) {
                    showError('Geolocation is not supported by your browser');
                    return;
                }
                
                try {
                    setLoading(true);
                    const position = await getCurrentPosition();
                    const { latitude, longitude } = position.coords;
                    state.location = { lat: latitude, lon: longitude };
                    
                    // Get city name from coordinates
                    const city = await reverseGeocode(latitude, longitude);
                    if (city) {
                        elements.cityInput.value = city;
                        await loadWeatherData(city, latitude, longitude);
                    } else {
                        await loadWeatherByCoords(latitude, longitude);
                    }
                    
                    // Initialize map if enabled
                    if (config.features.maps && !state.mapInitialized) {
                        initMap(latitude, longitude);
                        state.mapInitialized = true;
                    }
                } catch (error) {
                    showError(error.message || 'Failed to get your location');
                    console.error('Location error:', error);
                } finally {
                    setLoading(false);
                }
            }
            
            function getCurrentPosition() {
                return new Promise((resolve, reject) => {
                    navigator.geolocation.getCurrentPosition(resolve, reject, {
                        enableHighAccuracy: true,
                        timeout: 10000,
                        maximumAge: 60000
                    });
                });
            }
            
            async function reverseGeocode(lat, lon) {
                try {
                    const response = await fetch(
                        `https://api.openweathermap.org/geo/1.0/reverse?lat=${lat}&lon=${lon}&limit=1&appid=${config.apiKeys.weather}`
                    );
                    if (!response.ok) throw new Error('Reverse geocoding failed');
                    
                    const data = await response.json();
                    return data[0]?.name;
                } catch (error) {
                    console.error('Reverse geocode error:', error);
                    return null;
                }
            }
            
            async function loadWeatherData(city, lat, lon) {
                try {
                    setLoading(true);
                    clearError();
                    
                    // Check cache first
                    const cacheKey = `weather-${city}-${state.unit}`;
                    if (config.cache.enabled && state.cache.has(cacheKey)) {
                        const cached = state.cache.get(cacheKey);
                        if (Date.now() - cached.timestamp < config.cache.duration) {
                            updateUI(cached.data);
                            return;
                        }
                    }
                    
                    // Rate limiting
                    const now = Date.now();
                    if (now - state.lastRequestTime < 1000) {
                        await new Promise(resolve => setTimeout(resolve, 1000 - (now - state.lastRequestTime)));
                    }
                    
                    // Fetch weather data
                    const weatherData = await fetchWeather(city, lat, lon);
                    state.currentWeather = weatherData.current;
                    state.forecast = weatherData.forecast;
                    
                    // Fetch air quality if enabled
                    if (config.features.airQuality) {
                        try {
                            const aqData = await fetchAirQuality(lat || weatherData.current.coord.lat, lon || weatherData.current.coord.lon);
                            state.airQuality = aqData;
                        } catch (aqError) {
                            console.error('Air quality fetch error:', aqError);
                            state.airQuality = null;
                        }
                    }
                    
                    // Update cache
                    if (config.cache.enabled) {
                        state.cache.set(cacheKey, {
                            data: {
                                current: state.currentWeather,
                                forecast: state.forecast,
                                airQuality: state.airQuality
                            },
                            timestamp: Date.now()
                        });
                    }
                    
                    // Update UI
                    updateUI({
                        current: state.currentWeather,
                        forecast: state.forecast,
                        airQuality: state.airQuality
                    });
                    
                    // Update last request time
                    state.lastRequestTime = Date.now();
                } catch (error) {
                    showError(error.message || 'Failed to load weather data');
                    console.error('Weather load error:', error);
                } finally {
                    setLoading(false);
                }
            }
            
            async function loadWeatherByCoords(lat, lon) {
                try {
                    const weatherData = await fetchWeather(null, lat, lon);
                    state.currentWeather = weatherData.current;
                    state.forecast = weatherData.forecast;
                    
                    // Update UI with coordinates instead of city name
                    updateUI({
                        current: state.currentWeather,
                        forecast: state.forecast,
                        airQuality: state.airQuality
                    });
                } catch (error) {
                    throw error;
                }
            }
            
            async function fetchWeather(city, lat, lon) {
                let url;
                if (city) {
                    url = `https://api.openweathermap.org/data/2.5/weather?q=${encodeURIComponent(city)}&units=${state.unit}&appid=${config.apiKeys.weather}`;
                } else {
                    url = `https://api.openweathermap.org/data/2.5/weather?lat=${lat}&lon=${lon}&units=${state.unit}&appid=${config.apiKeys.weather}`;
                }
                
                const [currentRes, forecastRes] = await Promise.all([
                    fetchWithTimeout(url),
                    fetchWithTimeout(`https://api.openweathermap.org/data/2.5/forecast?${city ? `q=${encodeURIComponent(city)}` : `lat=${lat}&lon=${lon}`}&units=${state.unit}&appid=${config.apiKeys.weather}`)
                ]);
                
                if (!currentRes.ok || !forecastRes.ok) {
                    const error = await currentRes.json();
                    throw new Error(error.message || 'Failed to fetch weather data');
                }
                
                return {
                    current: await currentRes.json(),
                    forecast: await forecastRes.json()
                };
            }
            
            async function fetchAirQuality(lat, lon) {
                try {
                    const response = await fetchWithTimeout(
                        `http://api.openweathermap.org/data/2.5/air_pollution?lat=${lat}&lon=${lon}&appid=${config.apiKeys.weather}`
                    );
                    
                    if (!response.ok) throw new Error('Air quality data not available');
                    
                    return await response.json();
                } catch (error) {
                    throw error;
                }
            }
            
            function fetchWithTimeout(url, timeout = 10000) {
                return Promise.race([
                    fetch(url),
                    new Promise((_, reject) => 
                        setTimeout(() => reject(new Error('Request timeout')), timeout)
                    )
                ]);
            }
            
            function updateUI(data) {
                updateCurrentWeather(data.current);
                updateForecast(data.forecast);
                if (data.airQuality) updateAirQuality(data.airQuality);
                
                // Animate the weather card
                if (config.ui.animations) {
                    elements.weatherApp.classList.remove('pulse');
                    void elements.weatherApp.offsetWidth; // Trigger reflow
                    elements.weatherApp.classList.add('pulse');
                }
            }
            
            function updateCurrentWeather(current) {
                elements.cityName.textContent = `${current.name}, ${current.sys.country || ''}`;
                elements.temperature.textContent = `${Math.round(current.main.temp)}°${state.unit === 'metric' ? 'C' : 'F'}`;
                elements.weatherDescription.textContent = current.weather[0].description;
                elements.weatherIcon.src = `https://openweathermap.org/img/wn/${current.weather[0].icon}@2x.png`;
                elements.weatherIcon.alt = current.weather[0].description;
                
                // Weather details
                elements.humidity.textContent = `${current.main.humidity}%`;
                elements.windSpeed.textContent = `${Math.round(current.wind.speed * (state.unit === 'metric' ? 3.6 : 1))} ${state.unit === 'metric' ? 'km/h' : 'mph'}`;
                elements.feelsLike.textContent = `${Math.round(current.main.feels_like)}°${state.unit === 'metric' ? 'C' : 'F'}`;
                elements.pressure.textContent = `${current.main.pressure} hPa`;
                elements.visibility.textContent = `${(current.visibility / 1000).toFixed(1)} km`;
                elements.cloudCover.textContent = `${current.clouds.all}%`;
                
                // Additional weather info
                if (current.rain) {
                    elements.rainVolume.textContent = current.rain['1h'] || current.rain['3h'] || '0';
                } else {
                    elements.rainVolume.textContent = '0';
                }
                
                if (current.snow) {
                    elements.snowVolume.textContent = current.snow['1h'] || current.snow['3h'] || '0';
                } else {
                    elements.snowVolume.textContent = '0';
                }
                
                // Sunrise/sunset times
                const sunriseTime = new Date(current.sys.sunrise * 1000);
                const sunsetTime = new Date(current.sys.sunset * 1000);
                elements.sunrise.textContent = sunriseTime.toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' });
                elements.sunset.textContent = sunsetTime.toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' });
                
                // Update map if available
                if (state.mapInitialized && state.map) {
                    updateMap(current.coord.lat, current.coord.lon);
                }
            }
            
            function updateForecast(forecast) {
                updateHourlyForecast(forecast);
                updateDailyForecast(forecast);
            }
            
            function updateHourlyForecast(forecast) {
                if (!config.features.hourlyForecast) return;
                
                elements.hourlyForecast.innerHTML = '';
                const now = new Date();
                const currentHour = now.getHours();
                
                // Show next 24 hours (8 data points at 3-hour intervals)
                for (let i = 0; i < 8; i++) {
                    const item = forecast.list[i];
                    const time = new Date(item.dt * 1000);
                    const hour = time.getHours();
                    
                    const hourlyItem = document.createElement('div');
                    hourlyItem.className = 'hourly-item';
                    
                    // Format time display
                    let timeDisplay;
                    if (i === 0) {
                        timeDisplay = 'Now';
                    } else {
                        timeDisplay = time.toLocaleTimeString([], { hour: 'numeric' });
                    }
                    
                    hourlyItem.innerHTML = `
                        <div class="hourly-time">${timeDisplay}</div>
                        <img class="hourly-icon" src="https://openweathermap.org/img/wn/${item.weather[0].icon}.png" alt="${item.weather[0].description}" loading="lazy">
                        <div class="hourly-temp">${Math.round(item.main.temp)}°</div>
                    `;
                    
                    elements.hourlyForecast.appendChild(hourlyItem);
                }
            }
            
            function updateDailyForecast(forecast) {
                elements.dailyForecast.innerHTML = '';
                
                // Group by day
                const dailyData = {};
                const now = new Date();
                const today = now.toLocaleDateString('en-US', { weekday: 'short' });
                
                forecast.list.forEach(item => {
                    const date = new Date(item.dt * 1000);
                    const day = date.toLocaleDateString('en-US', { weekday: 'short' });
                    
                    // Skip today
                    if (day === today) return;
                    
                    if (!dailyData[day]) {
                        dailyData[day] = {
                            temp_max: item.main.temp_max,
                            temp_min: item.main.temp_min,
                            icon: item.weather[0].icon,
                            description: item.weather[0].description
                        };
                    } else {
                        // Update max/min temps
                        if (item.main.temp_max > dailyData[day].temp_max) {
                            dailyData[day].temp_max = item.main.temp_max;
                        }
                        if (item.main.temp_min < dailyData[day].temp_min) {
                            dailyData[day].temp_min = item.main.temp_min;
                        }
                    }
                });
                
                // Display next 5 days
                Object.keys(dailyData).slice(0, 5).forEach(day => {
                    const data = dailyData[day];
                    const dailyItem = document.createElement('div');
                    dailyItem.className = 'daily-item';
                    
                    dailyItem.innerHTML = `
                        <div class="daily-day">${day}</div>
                        <img class="daily-icon" src="https://openweathermap.org/img/wn/${data.icon}.png" alt="${data.description}" loading="lazy">
                        <div class="daily-temps">
                            <div class="daily-max">${Math.round(data.temp_max)}°</div>
                            <div class="daily-min">${Math.round(data.temp_min)}°</div>
                        </div>
                    `;
                    
                    elements.dailyForecast.appendChild(dailyItem);
                });
            }
            
            function updateAirQuality(airQuality) {
                if (!airQuality || !airQuality.list || !airQuality.list[0]) {
                    elements.aqiValue.textContent = '--';
                    elements.aqiCategory.textContent = '--';
                    elements.airQualityDesc.textContent = 'Air quality data not available';
                    return;
                }
                
                const aqi = airQuality.list[0].main.aqi;
                elements.aqiValue.textContent = aqi;
                
                // AQI categories
                let category, description, className;
                switch (aqi) {
                    case 1:
                        category = 'Good';
                        description = 'Air quality is satisfactory, and air pollution poses little or no risk.';
                        className = 'aqi-good';
                        break;
                    case 2:
                        category = 'Fair';
                        description = 'Air quality is acceptable. However, there may be a risk for some people.';
                        className = 'aqi-moderate';
                        break;
                    case 3:
                        category = 'Moderate';
                        description = 'Members of sensitive groups may experience health effects.';
                        className = 'aqi-unhealthy-sensitive';
                        break;
                    case 4:
                        category = 'Poor';
                        description = 'Some members of the general public may experience health effects.';
                        className = 'aqi-unhealthy';
                        break;
                    case 5:
                        category = 'Very Poor';
                        description = 'Health alert: The risk of health effects is increased for everyone.';
                        className = 'aqi-very-unhealthy';
                        break;
                    default:
                        category = '--';
                        description = 'Air quality data not available';
                        className = '';
                }
                
                elements.aqiCategory.textContent = category;
                elements.aqiCategory.className = `aqi-category ${className}`;
                elements.airQualityDesc.textContent = description;
            }
            
            function initMap(lat, lon) {
                // This is a placeholder for map initialization
                // In a real implementation, you would use Mapbox, Google Maps, or Leaflet
                console.log(`Initializing map at ${lat}, ${lon}`);
                
                // For a real implementation, you would do something like:
                /*
                mapboxgl.accessToken = config.apiKeys.map;
                state.map = new mapboxgl.Map({
                    container: 'map-container',
                    style: 'mapbox://styles/mapbox/streets-v11',
                    center: [lon, lat],
                    zoom: 10
                });
                
                new mapboxgl.Marker()
                    .setLngLat([lon, lat])
                    .addTo(state.map);
                */
                
                // For this example, we'll just show the coordinates
                const mapContainer = document.querySelector('.map-container');
                mapContainer.innerHTML = `
                    <div style="padding: 20px; text-align: center;">
                        <h4 style="margin-bottom: 10px;">Location Map</h4>
                        <p>Latitude: ${lat.toFixed(4)}</p>
                        <p>Longitude: ${lon.toFixed(4)}</p>
                        <p style="margin-top: 10px; font-size: 0.8em;">
                            <i class="fas fa-info-circle"></i> Map would display here with API key
                        </p>
                    </div>
                `;
            }
            
            function updateMap(lat, lon) {
                if (state.map) {
                    // In a real implementation, you would update the map center
                    // state.map.flyTo({ center: [lon, lat], zoom: 10 });
                    console.log(`Updating map to ${lat}, ${lon}`);
                }
            }
            
            function setUnits(unit) {
                if (state.unit === unit) return;
                
                state.unit = unit;
                elements.celsiusBtn.classList.toggle('active', unit === 'metric');
                elements.fahrenheitBtn.classList.toggle('active', unit === 'imperial');
                
                // Reload weather for current location
                const currentCity = elements.cityInput.value.trim() || config.defaultCity;
                loadWeatherData(currentCity);
            }
            
            function setLoading(isLoading) {
                elements.loadingOverlay.classList.toggle('active', isLoading);
            }
            
            function showError(message) {
                elements.errorText.textContent = message;
                elements.errorMessage.classList.add('active');
            }
            
            function clearError() {
                elements.errorMessage.classList.remove('active');
            }
            
            // Utility function to get weather icon based on code
            function getWeatherIcon(code) {
                const icons = {
                    '01d': 'sun',
                    '01n': 'moon',
                    '02d': 'cloud-sun',
                    '02n': 'cloud-moon',
                    '03d': 'cloud',
                    '03n': 'cloud',
                    '04d': 'cloud',
                    '04n': 'cloud',
                    '09d': 'cloud-rain',
                    '09n': 'cloud-rain',
                    '10d': 'cloud-sun-rain',
                    '10n': 'cloud-moon-rain',
                    '11d': 'bolt',
                    '11n': 'bolt',
                    '13d': 'snowflake',
                    '13n': 'snowflake',
                    '50d': 'smog',
                    '50n': 'smog'
                };
                return icons[code] || 'cloud';
            }
        });
    </script>
</body>
</html>